<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Decrypt Parcel QR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #f9f9f9;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 500px;
      width: 100%;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #218838;
    }
    #reader {
      width: 100%;
      margin-top: 20px;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      background: #f1f1f1;
      border-radius: 8px;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Decrypt Parcel QR</h2>
    <p>Scan the encrypted QR code and enter the password:</p>

    <div id="reader"></div>
    <input type="password" id="password" placeholder="Enter Password">
    <button onclick="decryptData()">Decrypt Data</button>

    <div id="result"></div>
  </div>

  <script>
    let scannedData = "";

    // Initialize QR scanner
    function onScanSuccess(decodedText) {
      scannedData = decodedText;
      document.getElementById("result").innerHTML = 
        "<b>Encrypted Data:</b><br>" + scannedData;
    }

    function onScanFailure(error) {
      // Ignoring scan errors
    }

    const html5QrcodeScanner = new Html5QrcodeScanner(
      "reader", { fps: 10, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);

    // Decrypt function
    function decryptData() {
      if (!scannedData) {
        alert("Please scan a QR code first!");
        return;
      }
      const password = document.getElementById("password").value;
      if (!password) {
        alert("Enter password!");
        return;
      }

      // Remove ENC: prefix if exists
      let encryptedText = scannedData.startsWith("ENC:") 
                          ? scannedData.slice(4) 
                          : scannedData;

      try {
        const bytes = CryptoJS.AES.decrypt(encryptedText, password);
        const decrypted = bytes.toString(CryptoJS.enc.Utf8);
        if (!decrypted) throw new Error("Wrong password");

        const customerData = JSON.parse(decrypted);
        document.getElementById("result").innerHTML =
          "<b>Decrypted Customer Data:</b><br>" +
          "Name: " + customerData.name + "<br>" +
          "Address: " + customerData.address + "<br>" +
          "Phone: " + customerData.phone + "<br>" +
          "Email: " + customerData.email;
      } catch (e) {
        alert("Failed to decrypt. Wrong password or corrupted QR.");
      }
    }
  </script>
</body>
</html>
